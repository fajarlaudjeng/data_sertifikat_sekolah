<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Sertifikat Satuan Pendidikan</title>

<!-- Bootstrap -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<!-- Tailwind -->
<script src="https://cdn.tailwindcss.com"></script>

<style>
iframe { width:100%; height:480px; border:none; }
.header-logo { height:75px; }
.spinner {
    border: 4px solid #f3f3f3;
    border-top: 4px solid #0d6efd;
    border-radius: 50%;
    width: 36px;
    height: 36px;
    animation: spin 1s linear infinite;
    margin: auto;
}
@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
.carousel-inner img { max-height: 300px; object-fit: contain; }
</style>
</head>

<body class="bg-gray-100">

<div class="container my-4 max-w-5xl">

<!-- HEADER -->
<div class="card shadow p-3 mb-4">
    <div class="row align-items-center text-center">
        <div class="col-3 text-start">
            <img src="https://upload.wikimedia.org/wikipedia/commons/e/e5/Lambang_Kabupaten_Donggala_%282015-sekarang%29.png" class="header-logo">
        </div>
        <div class="col-6">
            <h6 class="fw-bold mb-1">PEMERINTAH KABUPATEN DONGGALA</h6>
            <h6 class="fw-bold mb-1">DINAS PENDIDIKAN DAN KEBUDAYAAN</h6>
            <small>Jalan Jati Nomor ....</small>
        </div>
        <div class="col-3 text-end">
            <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/9/9c/Logo_of_Ministry_of_Education_and_Culture_of_Republic_of_Indonesia.svg/960px-Logo_of_Ministry_of_Education_and_Culture_of_Republic_of_Indonesia.svg.png" class="header-logo">
        </div>
    </div>
</div>

<!-- CONTENT -->
<div class="card shadow-lg p-4">
    <div class="row align-items-start">

        <!-- LEFT -->
        <div class="col-md-8 col-12">
            <h4 class="text-center mb-3 fw-bold">Cek Sertifikat Sekolah</h4>

            <input type="text" id="npsn" class="form-control mb-2" placeholder="Masukkan NPSN">
            <button onclick="login()" class="btn btn-primary w-100 mb-3">
                Cek Sertifikat
            </button>

            <div id="hasil"></div>
        </div>

        <!-- RIGHT IMAGE -->
        <div class="col-md-4 col-12 text-center mt-4 mt-md-0">
            <img
                src="https://ctzen.id/wp-content/uploads/2025/01/IMG-20250114-WA0003.jpg"
                class="img-fluid rounded shadow-sm"
                style="max-height:240px"
                alt="Gambar Kantor Bupati">
            <p class="text-sm text-gray-500 mt-2">
                Sistem Informasi Sertifikat<br>
                Satuan Pendidikan
            </p>
        </div>

    </div>
</div>

<!-- FOOTER -->
<div class="text-center mt-4 text-sm text-gray-600">
    <hr>
    <p class="fw-semibold mt-2">
        Badan Pengelolaan Keuangan dan Aset Daerah<br>
        Bidang Aset Daerah
    </p>
</div>

</div>

<script>
const sheetURL = "https://docs.google.com/spreadsheets/d/16HIXSuw_JEDrBT2FTkGCfhVbfeOGiuQBwcxuTvbl_0Y/gviz/tq?sheet=database";

function login() {
    const npsnInput = document.getElementById("npsn").value.trim();

    if(!/^\d{8}$/.test(npsnInput)){
        hasil.innerHTML = `<div class="alert alert-warning">NPSN harus 8 digit angka.</div>`;
        return;
    }

    hasil.innerHTML = `<div class="spinner mt-3"></div>`;

    fetch(sheetURL)
    .then(res => res.text())
    .then(text => {
        const json = JSON.parse(text.substring(47).slice(0, -2));
        const rows = json.table.rows;

        const row = rows.find(r => r.c[1]?.v == npsnInput);

        if (!row) {
            hasil.innerHTML = `<div class="alert alert-danger">NPSN tidak ditemukan</div>`;
            return;
        }

        const latitude = row.c[14]?.v;
        const longitude = row.c[15]?.v;

        hasil.innerHTML = `
        <div class="table-responsive mt-3">
        <table class="table table-bordered">
            <tr><th>Nama Sekolah</th><td>${row.c[2]?.v || "-"}</td></tr>
            <tr><th>Alamat</th><td>${row.c[3]?.v || "-"}, ${row.c[4]?.v || "-"}, ${row.c[6]?.v || "-"}</td></tr>
            <tr><th>Status</th><td>${row.c[5]?.v || "-"}</td></tr>
            <tr><th>Sertifikat</th><td>${btnPreview(row.c[7]?.v, "pdf")}</td></tr>
            <tr><th>Rumah Dinas Guru</th><td>${btnPreview(row.c[8]?.v, "pdf")}</td></tr>
            <tr><th>Gambar</th>
                <td>${carouselImages([row.c[9]?.v,row.c[10]?.v,row.c[11]?.v,row.c[13]?.v])}</td>
            </tr>
            <tr><th>Koordinat</th>
                <td>${latitude && longitude ? `<button class="btn btn-info btn-sm" onclick="lihatPeta(${latitude},${longitude})">üìç Lihat Peta</button>` : "-"}</td>
            </tr>
        </table>
        </div>
        <div id="preview" class="mt-3"></div>
        `;
    })
    .catch(err => {
        hasil.innerHTML = `<div class="alert alert-danger">Terjadi kesalahan: ${err}</div>`;
    });
}

// Tombol preview PDF
function btnPreview(link, type){
    if(link && link.includes("http")){
        if(type === "pdf"){
            return `<button class="btn btn-success btn-sm" onclick="preview('${link}')">üëÅ Lihat PDF</button>`;
        }
    }
    return "-";
}

// Ubah link Google Drive jadi link gambar langsung
function driveImagePreview(link){
    const match = link.match(/\/d\/([a-zA-Z0-9_-]+)/);
    if(match){
        const fileId = match[1];
        return `https://drive.google.com/uc?export=view&id=${fileId}`;
    }
    return link;
}

// Carousel untuk preview gambar
function carouselImages(links){
    const validLinks = links.filter(l => l && l.includes("http"));
    if(validLinks.length === 0) return "-";

    let indicators = '';
    let inner = '';
    validLinks.forEach((link,i)=>{
        const previewLink = driveImagePreview(link); // pakai link preview
        indicators += `<button type="button" data-bs-target="#carouselPreview" data-bs-slide-to="${i}" ${i===0?'class="active" aria-current="true"':''} aria-label="Slide ${i+1}"></button>`;
        inner += `
        <div class="carousel-item ${i===0?'active':''}">
            <img src="${previewLink}" class="d-block w-100" alt="Preview Gambar">
            <a href="${link}" target="_blank" class="btn btn-warning btn-sm mt-2 w-100">‚¨áÔ∏è Download</a>
        </div>
        `;
    });

    return `
    <div id="carouselPreview" class="carousel slide" data-bs-ride="carousel">
        <div class="carousel-indicators">
            ${indicators}
        </div>
        <div class="carousel-inner">
            ${inner}
        </div>
        <button class="carousel-control-prev" type="button" data-bs-target="#carouselPreview" data-bs-slide="prev">
            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
            <span class="visually-hidden">Previous</span>
        </button>
        <button class="carousel-control-next" type="button" data-bs-target="#carouselPreview" data-bs-slide="next">
            <span class="carousel-control-next-icon" aria-hidden="true"></span>
            <span class="visually-hidden">Next</span>
        </button>
    </div>
    `;
}

// Preview PDF
function preview(link){
    const fileId = link.match(/\/d\/([^\/]+)/)?.[1] || link;
    const previewUrl = link.includes("drive.google.com") 
        ? `https://drive.google.com/file/d/${fileId}/preview` 
        : link;

    document.getElementById("preview").innerHTML = `
    <div class="card p-3">
        <iframe src="${previewUrl}"></iframe>
        <a href="${link}" target="_blank" class="btn btn-warning mt-2 w-100">‚¨áÔ∏è Download</a>
    </div>
    `;
}

// Google Maps
function lihatPeta(lat, lng){
    const url = `https://www.google.com/maps?q=${lat},${lng}&z=18`;
    window.open(url, "_blank");
}
</script>

</body>
</html>
